-- CREATE DATABASE LAB10
-- DROP TABLE THANNHAN

-- CREATE TABLE NHANVIEN(
-- HONV VARCHAR(30) NOT NULL,
-- TENLOT VARCHAR(30) NOT NULL,
-- TEN VARCHAR(30) NOT NULL,
-- MANV VARCHAR(20) NOT NULL,
-- NGSINH DATE NOT NULL,
-- DCHI VARCHAR(100) NOT NULL,
-- PHAI VARCHAR(10) NOT NULL,
-- LUONG INT NOT NULL,
-- MA_NQL VARCHAR(10) NOT NULL,
-- PHG INT NOT NULL
-- )

-- INSERT INTO NHANVIEN(HONV,TENLOT,TEN,MANV,NGSINH,DCHI,PHAI,LUONG,MA_NQL,PHG)
-- VALUES
-- ('Dinh','Ba','Tien','123456789','1955-01-09','731 Tran Hung Dao, Q1, TPHCM','Nam',30000,'333445555',5),
-- ('Nguyen','Thanh','Tung','333445555','1945-12-08','638 Nguyen Van Cu, Q5, TPHCM','Nam',40000,'888665555',5),
-- ('Bui','Thuy','Vu','999887777','1958-07-19','332 Nguyen Thai Hoc, Q1, TPHCM','Nam',25000,'987654321',4),
-- ('Le','Thi','Nhan','987654321','1931-06-20','291 Ho Van Hue, QPN, TPHCM','Nu',43000,'888665555',4),
-- ('Nguyen','Manh','Hung','666884444','1952-09-15','975 Ba Ria, Vung Tau','Nam',38000,'333445555',5),
-- ('Tran','Thanh','Tam','453453453','1962-07-31','543 Mai Thi Luu, Q1, TPHCM','Nam',25000,'333445555',5),
-- ('Tran','Hong','Quan','987987987','1959-03-29','980Le Hong Phong, Q10, TPHCM','Nam',25000,'333445555',4),
-- ('Vuong','Ngoc','Quyen','888665555','1927-10-10','450 Trung Vuong, HaNoi','Nu',55000,'',1);

-- CREATE TABLE PHONGBAN(
-- 	TENPHG VARCHAR(15),
-- 	MAPH INT,
-- 	TRPHG VARCHAR(20),
-- 	NG_NHANCHUC VARCHAR(20)
-- );
-- INSERT INTO PHONGBAN VALUES 
-- ('Nghien cuu',5,'3334445555','22/05/1978'),
-- ('Dieu hanh',4,'987987987','01/01/1985'),
-- ('Quan ly',1,'888665555','22/05/1978');

-- CREATE TABLE DIADIEM_PHG(
--     MAPHG INT ,
--     DIADIEM VARCHAR(30)
-- )
-- CREATE TABLE DEAN(
--     TENDA VARCHAR(30),
--     MADA INT PRIMARY KEY,
--     DDIEM_DA VARCHAR(30),
--     PHONG INT
-- )
-- INSERT INTO DIADIEM_PHG VALUES
-- ( '1', 'TP HCM'),
-- ('4','HA NOI'),
-- ('5','VUNG TAU'),
-- ('5','NHA TRANG'),
-- ('5','TP HCM');
-- INSERT INTO DEAN VALUES 
-- ('San pham X','1','VUNG TAU','5'),
-- ('San pham Y','2','NHA TRANG','5'),
-- ('San pham Z','3','TP HCM','5'),
-- ('Tin quoc hoa','10','HA NOI','4'),
-- ('Cap quang','20','TP HCM ','1'),
-- ('Dao tao','30','HA NOI','4');

-- CREATE TABLE [dbo].[THANNHAN] (
--     [MA_NVIEN] INT          NOT NULL,
--     [TENTN]    VARCHAR (30) NOT NULL,
--     [PHAI]     VARCHAR (10) NULL,
--     [NGSINH]   DATE         NULL,
--     [QUANHE]   VARCHAR (30) NULL,
--     CONSTRAINT [PK_THANNHAN] PRIMARY KEY CLUSTERED (MA_NVIEN,TENTN)
-- );

-- INSERT INTO THANNHAN (MA_NVIEN,TENTN,PHAI,NGSINH,QUANHE)
-- VALUES
--   (333445555,'Quang','Nu','1976/04/05','Con gai'),
--   (333445555,'Khang','Nam','1973/10/25','Con trai'),
--   (333445555,'Duong','Nu','1948/05/03','Vo chong'),
--   (987654321,'Dang','Nam','1932/02/29','Vo chong'),
--   (123456789,'Duy','Nam','1978/01/01','Con trai'),
--   (123456789,'Chau','Nu','1978/12/31','Con gai');

-- CREATE TABLE PHANCONG(
-- 	MA_NHANVIEN VARCHAR(15),
-- 	SODA INT,
-- 	THOIGIAN FLOAT,
-- 	PRIMARY KEY (MA_NHANVIEN,SODA)
-- );
-- INSERT INTO PHANCONG VALUES 
-- ('123456789',1,32.5),
-- ('123456789',2,7.5),
-- ('666884444',3,40.0),
-- ('453453453',1,20.0),
-- ('453453453',2,20.0),
-- ('333445555',3,10.0),
-- ('333445555',10,10.0),
-- ('333445555',20,10.0),
-- ('999887777',30,30.0),
-- ('999887777',10,10.0),
-- ('987987987',10,35.0),
-- ('987987987',30,5.0),
-- ('987654321',30,20.0),
-- ('987654321',20,15.0),
-- ('888665555',20,NULL);

------I----------------

-- WITH TMP1 AS ( 
--     SELECT NHANVIEN.TEN , NHANVIEN.MANV FROM NHANVIEN
-- )
-- SELECT NHANVIEN.MANV,NHANVIEN.HONV,NHANVIEN.TENLOT,NHANVIEN.TEN,PHONGBAN.NG_NHANCHUC,NHANVIEN.MA_NQL,TMP1.TEN AS TEN_NQL
-- FROM NHANVIEN
-- LEFT JOIN TMP1 ON NHANVIEN.MA_NQL = TMP1.MANV
-- LEFT JOIN PHONGBAN ON NHANVIEN.MANV = PHONGBAN.TRPHG

-- CREATE PROCEDURE SP_1
-- AS
-- WITH TMP1 AS (
--     SELECT NHANVIEN.TEN , NHANVIEN.MANV FROM NHANVIEN
-- )
-- SELECT NHANVIEN.MANV,NHANVIEN.HONV,NHANVIEN.TENLOT,NHANVIEN.TEN,PHONGBAN.NG_NHANCHUC,NHANVIEN.MA_NQL,TMP1.TEN AS TEN_NQL
-- FROM NHANVIEN
-- LEFT JOIN TMP1 ON NHANVIEN.MA_NQL = TMP1.MANV
-- LEFT JOIN PHONGBAN ON NHANVIEN.MANV = PHONGBAN.TRPHG;

-- 1.1
-- CREATE PROCEDURE SP_1
-- AS
-- WITH TMP1 AS (
--     SELECT NHANVIEN.TEN , NHANVIEN.MANV FROM NHANVIEN
-- )
-- SELECT NHANVIEN.MANV,NHANVIEN.HONV,NHANVIEN.TENLOT,NHANVIEN.TEN,PHONGBAN.NG_NHANCHUC,NHANVIEN.MA_NQL,TMP1.TEN AS TEN_NQL
-- FROM NHANVIEN
-- LEFT JOIN TMP1 ON NHANVIEN.MA_NQL = TMP1.MANV
-- LEFT JOIN PHONGBAN ON NHANVIEN.MANV = PHONGBAN.TRPHG;
-- EXEC SP_1;
-- --- 1.2
-- CREATE PROCEDURE SP_2
-- AS
-- SELECT NHANVIEN.MANV,NHANVIEN.HONV,NHANVIEN.TENLOT,NHANVIEN.TEN,NHANVIEN.LUONG
-- FROM NHANVIEN 
-- WHERE NHANVIEN.MANV IN (
--     SELECT NHANVIEN.MANV WHERE (NHANVIEN.LUONG) >= ALL(SELECT AVG(LUONG) AS AVGLUONG
-- FROM NHANVIEN)
-- )  ;
-- EXEC SP_2;

--- 1.3
-- CREATE PROCEDURE SP_3 @N INT
-- AS
-- SELECT NHANVIEN.MANV,NHANVIEN.HONV,NHANVIEN.TENLOT,NHANVIEN.TEN,NHANVIEN.LUONG
-- FROM NHANVIEN
-- WHERE 
-- (
--   LUONG IN 
--   (
--     SELECT TOP (@N) LUONG
--     FROM NHANVIEN as table1
--     GROUP BY LUONG
--     ORDER BY LUONG DESC
--   )
-- )
-- EXEC SP_3 @N = 4;

-- 1.4
CREATE PROCEDURE SP_4 @CITY VARCHAR(15)
AS
UPDATE NHANVIEN
SET LUONG = LUONG + (LUONG * 10/100)
WHERE NHANVIEN.MANV IN ( SELECT NHANVIEN.MANV FROM NHANVIEN
LEFT JOIN DIADIEM_PHG ON NHANVIEN.PHG = DIADIEM_PHG.MAPHG
WHERE DIADIEM_PHG.DIADIEM = @CITY);

EXEC SP_4 @CITY = 'TP HCM';
-- check : 
 SELECT NHANVIEN.TEN, NHANVIEN.MANV, NHANVIEN.LUONG FROM NHANVIEN
 LEFT JOIN DIADIEM_PHG ON NHANVIEN.PHG = DIADIEM_PHG.MAPHG
 WHERE DIADIEM_PHG.DIADIEM = 'TP HCM';

--1.5
DELETE FROM PHONGBAN
WHERE PHONGBAN.MAPH NOT IN (SELECT NHANVIEN.PHG FROM NHANVIEN)

--2
-- II
CREATE TRIGGER AGV_NHANVIEN
ON NHANVIEN
FOR INSERT,DELETE
AS
BEGIN
DECLARE @AVG1 FLOAT = 0;
DECLARE @AVG2 FLOAT = 0;
SELECT @AVG1 = AVG(LUONG) FROM inserted;
PRINT @AVG1
SELECT @AVG2 = AVG(LUONG) FROM deleted;
PRINT @AVG2
IF(@AVG1 >50000 OR @AVG2 > 50000 )
BEGIN
PRINT N'AVG(LUONG) vượt quá 50000'
ROLLBACK TRAN
END
END;


INSERT INTO NHANVIEN(HONV,TENLOT,TEN,MANV,NGSINH,DCHI,PHAI,LUONG,MA_NQL,PHG)
VALUES
('Dinh','Ba','Tien','123456789','1955-01-09','731 Tran Hung Dao, Q1, TPHCM','Nam',2000000,'333445555',5)





CREATE TRIGGER CHECK_LUONG_TRP
ON NHANVIEN
FOR UPDATE, INSERT
AS 
BEGIN
DECLARE @COUNT INT = 0;
DECLARE @LUONG_NV INT = 0;
DECLARE @LUONG_NQL INT = 0;
SELECT @LUONG_NV = LUONG FROM inserted ;
SELECT @LUONG_NQL = LUONG FROM NHANVIEN
WHERE NHANVIEN.MA_NQL IN(
				SELECT  MA_NQL FROM inserted
				);
SELECT @COUNT = COUNT(MANV) FROM NHANVIEN
WHERE MANV NOT IN(SELECT MA_NQL FROM inserted)
	AND LUONG >= @LUONG_NQL;
IF (@COUNT != 0)
BEGIN
PRINT 'Luong nv qua cao'
ROLLBACK TRAN
END
END;
INSERT INTO NHANVIEN(HONV,TENLOT,TEN,MANV,NGSINH,DCHI,PHAI,LUONG,MA_NQL,PHG)
VALUES
('Dinh','Ba','Tien','1256789','1955-01-09','731 Tran Hung Dao, Q1, TPHCM','Nam',41000,'333445555',5)